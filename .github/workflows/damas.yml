name: "damas"

on:
  issues:
    types: [opened]

jobs:
  move:
    runs-on: ubuntu-latest
    if: startsWith(github.event.issue.title, 'damas-') 
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - if: startsWith(github.event.issue.title, 'damas-') && contains(github.event.issue.labels.*.name, 'test')
        run: |
          # the triggering issue contains test
          echo "${{ github.event_name }}"
          exit 1

      - name: Set env vars
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "${{ github.event_name }}"
          echo "REPOSITORY=${{ github.repository }}" >> $GITHUB_ENV
          echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_ENV
          echo "USER=${{ github.event.issue.user.login }}" >> $GITHUB_ENV

      - uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Setup
        run: |
          pip install PyGithub pydraughts

      - name: Play
        run: |
          python << EOF
          from github import Github
          from draughts import Board, Move, svg
          import os

          TOKEN = os.getenv("GITHUB_TOKEN")
          REPO = os.getenv("REPOSITORY")
          USER = os.getenv("USER")

          os.makedirs("assets", exist_ok=True)

          board = Board(variant="brazilian")

          try:
              move = Move(board, steps_move=[9, 13])
              board.push(move)
              move = Move(board, steps_move=[22, 18])
              board.push(move)
              move = Move(board, steps_move=[13, 22]) 
              board.push(move)

              svg_content = svg.create_svg(board)
              
              with open("assets/board.svg", "w") as file:
                  file.write(svg_content)

              with open("README.md", "a") as f:
                  f.write(f"## {USER} \n")
                  f.write(f"![board](assets/board.svg) \n")              
                  
          except ValueError as e:
              print(f"Invalid move: {e}")
              exit(1)
              
          except Exception as e:
              print(f"Error generating board.svg: {e}")
              exit(1)


          EOF

      - name: Commit files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add assets/board.svg README.md
          git diff --quiet && git diff --staged --quiet || git commit -m "Update board.svg and README"
          git push origin HEAD
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add assets/board.svg README.md
          git commit -m "Update board.svg and README"
          git push origin HEAD
